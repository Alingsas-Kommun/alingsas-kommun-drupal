<?php

/**
 *  @package Connector
 */

define('FLD_SESSION', '000');
define('FLD_LANGUAGE', '020');
define('FLD_NAMNPASSORD', '047');
define('FLD_SEARCHOWNORG', '048');
define('FLD_SEARCHORGNAME', '049');
define('FLD_SEARCHFLD', '050');
define('FLD_SEARCHREC', '051');
define('FLD_SEARCHTITLE', '052');
define('FLD_HEADERS', '053');
define('FLD_SEARCHHV', '054');
define('FLD_KORTNREC', '055');
define('FLD_FIELDS', '056');
define('FLD_SHOWFLD', '057');
define('FLD_FIELDIDS', '058');
define('FLD_SOKOMR', '060');
define('FLD_SOKOMRSPEC', '061');
define('FLD_TELSTATUS', '062');
define('FLD_SEARCHCONTENT', '063');
define('FLD_FIELDSWIDTH', '064');
define('FLD_ORGID', '070');
define('FLD_ORGSTRINGID', '071');
define('FLD_SORTFIELD', '072');
define('FLD_ORGRECURSIVE', '073');
define('FLD_ORGFORCELEVEL', '074');
define('FLD_INFO_TEMPLATE', '080');
define('FLD_INFO_ENUM', '090');
define('FLD_SEARCH_LIMIT', '091');
define('FLD_SEARCH_COUNT', '092');
define('FLD_ID', '100');
define('FLD_ANKNR', '101');
define('FLD_ANKNR2', '102');
define('FLD_SIGNON', '103');
define('FLD_EXTSESSION', '104');
define('FLD_OLDPASSWORD', '108');
define('FLD_PASSWORD', '109');
define('FLD_VAXEL', '110');
define('FLD_USERIP', '111');
define('FLD_ANVID', '112');
define('FLD_NOSMS', '113');
define('FLD_WEBADM', '114');
define('FLD_MASNR', '115');
define('FLD_LOGINVALUE', '116');
define('FLD_CELLPHONE_NUMBER', '117');
define('FLD_LANG', '118');
define('FLD_ID2', '119');
define('FLD_ANKNRHEMLIG', '121');
define('FLD_INFOID', '150');
define('FLD_INFOFLD', '155');
define('FLD_INT_TARGET', '180');
define('FLD_VK_TYPE', '185');
define('FLD_VK_VALUE', '186');
define('FLD_PBX_CALLHANDLE', '190');
define('FLD_PBX_CALLHANDLE2', '191');
define('FLD_PBX_TARGETNUMBER', '192');
define('FLD_PBX_PARKPOSITION', '193');
define('FLD_PBX_REDIRECTTOME', '194');
define('FLD_PBX_TYPE', '198');
define('FLD_PBX_TYPEID', '199');
define('FLD_NAMN', '200');
define('FLD_ORG', '202');
define('FLD_SOKORD', '203');
define('FLD_ORGINFO', '204');
define('FLD_ORGINFOID', '205');
define('FLD_SOKORD_TEXT', '206');
define('FLD_SOKORD_ID', '207');
define('FLD_REQNEW_ID', '220');
define('FLD_TIPS', '230');
define('FLD_TIPSID', '231');
define('FLD_TIPSTEXT', '232');
define('FLD_TIPSIKON', '233');
define('FLD_TIPSDETAILED', '235');
define('FLD_TIPSSTARTTID', '236');
define('FLD_TIPSSLUTTID', '237');
define('FLD_TIPSINTERVAL', '238');
define('FLD_TIPSERS', '239');
define('FLD_TIPSERS_ANKN', '240');
define('FLD_TIPSERS_ID', '241');
define('FLD_TIPSAKTIVT', '242');
define('FLD_TIPSLANKANTAL', '243');
define('FLD_STAT_HV', '280');
define('FLD_STAT_MSG', '281');
define('FLD_INFOUPD_ID', '290');
define('FLD_INFOUPD_TEXT', '291');
define('FLD_INFO', '299');
define('FLD_HV', '300');
define('FLD_HV_ID', '301');
define('FLD_HV_ORSAK', '302');
define('FLD_HV_FRITEXT', '303');
define('FLD_HV_START', '304');
define('FLD_HV_SLUT', '305');
define('FLD_HV_AKTIV', '306');
define('FLD_HV_SIGN', '307');
define('FLD_HV_TILLGANGLIG', '308');
define('FLD_HV_HVNR', '309');
define('FLD_HV_TELTEXT', '310');
define('FLD_HV_OTHER_ROLL', '311');
define('FLD_HV_NR', '312');
define('FLD_HV_OPPNAEJ', '313');
define('FLD_HV_GROUP', '314');
define('FLD_HV_STARTDAG', '315');
define('FLD_HV_SLUTDAG', '316');
define('FLD_HVFAST', '330');
define('FLD_HVFAST_ID', '331');
define('FLD_HVFAST_TEXT', '332');
define('FLD_HVFAST_PHONE', '333');
define('FLD_HVFAST_ORSAK', '334');
define('FLD_HVFAST_LENGTH_OVERRIDE', '335');
define('FLD_HVFAST_CAPTION', '336');
define('FLD_HVFAST_FROM', '337');
define('FLD_HVFAST_FROM_TEXT', '338');
define('FLD_HVFAST_LENGTH', '339');
define('FLD_HVFAST_LENGTH_TEXT', '340');
define('FLD_HVFAST_ORSAKTEXT', '341');
define('FLD_HVFAST_HVNR', '342');
define('FLD_HVFAST_RETURNTIME', '343');
define('FLD_HVFAST_DATA_FROM', '350');
define('FLD_HVFAST_DATA_FROM_ID', '351');
define('FLD_HVFAST_DATA_FROM_TEXT', '352');
define('FLD_HVFAST_DATA_LNGD', '355');
define('FLD_HVFAST_DATA_LNGD_ID', '356');
define('FLD_HVFAST_DATA_LNGD_TEXT', '357');
define('FLD_SCHEMA', '360');
define('FLD_SCHEMA_ID', '361');
define('FLD_SCHEMA_ORSAK', '362');
define('FLD_SCHEMA_DATFRAN', '363');
define('FLD_SCHEMA_DATTILL', '364');
define('FLD_SCHEMA_VECKA', '365');
define('FLD_SCHEMA_TIDFRAN', '366');
define('FLD_SCHEMA_TIDTILL', '367');
define('FLD_SCHEMA_DAGFRAN', '368');
define('FLD_SCHEMA_DAGTILL', '369');
define('FLD_SCHEMA_TEXT', '370');
define('FLD_SCHEMA_TILLGANGLIG', '371');
define('FLD_SCHEMA_KOD', '372');
define('FLD_SCHEMA_HVNR', '373');
define('FLD_SCHEMA_PRESENTSTARTDATE', '378');
define('FLD_SCHEMA_PRESENTDATA', '379');
define('FLD_SCHEMA_MASNR', '389');
define('FLD_MSG', '400');
define('FLD_MSG_ID', '401');
define('FLD_MSG_TEXT', '402');
define('FLD_MSG_DATE', '403');
define('FLD_MSG_SIGN', '405');
define('FLD_MSG_FROM', '407');
define('FLD_MSG_TO', '408');
define('FLD_MSG_DATEHEADER', '409');
define('FLD_MSG_KOD', '410');
define('FLD_MSG_FILENAME', '411');
define('FLD_MSG_SYSTEM', '412');
define('FLD_MSG_FROMNR', '413');
define('FLD_MSG_MACHINEI', '414');
define('FLD_MSG_STATUS', '415');
define('FLD_MSG_TO_NR', '416');
define('FLD_MSG_FROM_CONTACT', '417');
define('FLD_SUM_NEW_MESSAGES', '420');
define('FLD_SUM_OTHER_MESSAGES', '421');
define('FLD_SUM_TOTAL_MESSAGES', '422');
define('FLD_MSG_FORWARDFROM', '423');
define('FLD_MOTA_BESTILLF', '430');
define('FLD_MOTA_BESTILLF_ID', '431');
define('FLD_MOTA_BESTILLF_FRAN', '432');
define('FLD_MOTA_BESTILLF_TILL', '433');
define('FLD_MOTA_BESTILLF_KORTID', '434');
define('FLD_MOTA_BESTILLF_RECID', '435');
define('FLD_MOTA_BESTILLF_RECNAMN', '436');
define('FLD_MOTA_BESTILLF_STATUS', '437');
define('FLD_MOTA_BESTILLF_FRANSTR', '438');
define('FLD_MOTA_BESTILLF_TILLSTR', '439');
define('FLD_MOTA_MOTTAGARE', '440');
define('FLD_MOTA_MOTTAGARE_ID', '441');
define('FLD_MOTA_MOTTAGARE_FNAMN', '442');
define('FLD_MOTA_MOTTAGARE_ENAMN', '443');
define('FLD_MOTA_MOTTAGARE_ANKN', '444');
define('FLD_MOTA_BESOKARE', '450');
define('FLD_MOTA_BESOKARE_FNAMN', '451');
define('FLD_MOTA_BESOKARE_ENAMN', '452');
define('FLD_MOTA_BESOKARE_INFO', '453');
define('FLD_MOTA_BESOKARE_ID', '454');
define('FLD_MOTA_BESOKARE_TID', '455');
define('FLD_SEKR', '460');
define('FLD_SEKR_CLIENTID', '461');
define('FLD_SEKR_STATE', '462');
define('FLD_PERSBIL', '465');
define('FLD_PERSBILD_OP', '466');
define('FLD_PREFERRED_MEDSYS', '490');
define('FLD_USE_FLEXI', '491');
define('FLD_MSGSYS', '495');
define('FLD_MSGSYS_ID', '496');
define('FLD_MSGSYS_TEXT', '497');
define('FLD_TIM', '500');
define('FLD_MIN', '501');
define('FLD_MEDSYSID', '502');
define('FLD_ADDROLLMESSDELIV', '503');
define('FLD_DELROLLMESSDELIV', '504');
define('FLD_ROLLMEDID', '505');
define('FLD_MEDSYSIDS', '506');
define('FLD_ROLLMED_TEXT', '507');
define('FLD_ROLLMED_INFOID', '508');
define('FLD_ROLLMED_HVID', '509');
define('FLD_ROLLMED', '510');
define('FLD_CONTACTS', '600');
define('FLD_CONTACT_ID', '601');
define('FLD_CONTACT_NAME', '602');
define('FLD_CONTACT_EP', '603');
define('FLD_CONTACT_SMS', '604');
define('FLD_CONTACT_KAT', '605');
define('FLD_CONTACT_KAT_I', '606');
define('FLD_CONTACT_KAT_TE', '607');
define('FLD_CONTACT_KAT_G', '608');
define('FLD_STARTDATE', '610');
define('FLD_ENDDATE', '611');
define('FLD_MESSAGEBOX', '620');
define('FLD_COMPANY_ID', '621');
define('FLD_VMBOX_NAME', '622');
define('FLD_VMBOX_EXT', '623');
define('FLD_VMBOX_USER_ID', '624');
define('FLD_STAT', '660');
define('FLD_STAT_TEXT', '661');
define('FLD_STAT_TID', '662');
define('FLD_FLEXI_DB', '650');
define('FLD_FLEXI_PASSWD', '651');
define('FLD_FLEXI_USER', '652');
define('FLD_FLEXI_HOST', '653');
define('FLD_RBL_MAILBOX_ID', '670');
define('FLD_RBL_SPEED_LSTN', '671');
define('FLD_RBL_PERS_GREET', '672');
define('FLD_RBL_USER_ID', '673');
define('FLD_RBL_USER_RIGHTS', '674');
define('FLD_RBL_LCID', '675');
define('FLD_RBL_FIELD_ID', '676');
define('FLD_RBL_FIELD_ID2', '677');
define('FLD_RBL_ALT_NR', '678');
define('FLD_RBL_ATT_NR', '679');
define('FLD_RBL_ALLOW_PG', '680');
define('FLD_RBL_KOPPLAMOBIL', '681');
define('FLD_IVR_KUND', '682');
define('FLD_RBL_VMASEMAIL', '683');
define('FLD_RBL', '684');
define('FLD_INFOREQCHG_ID', '700');
define('FLD_INFOREQCHG_ROLLID', '701');
define('FLD_INFOREQCHG_TEXT', '702');
define('FLD_INFOREQCHG_DATE', '703');
define('FLD_INFOREQCHG_BY', '704');
define('FLD_INFOREQCHG_DATA', '705');
define('FLD_INFOREQCHG_SUM', '706');
define('FLD_BROWSE_ID', '750');
define('FLD_BROWSE_BRANCH', '751');
define('FLD_BROWSE_LEAF', '752');
define('FLD_BROWSE_INCLUDE_LEAVES', '759');
define('FLD_ORSAK', '800');
define('FLD_SC', '850');
define('FLD_SC_COMMANDS', '851');
define('FLD_SC_TITLE', '852');
define('FLD_SC_ID', '853');
define('FLD_CID', '860');
define('FLD_CID_ID', '861');
define('FLD_CID_DIRECTION', '862');
define('FLD_CID_STATUS', '863');
define('FLD_CID_ANR', '864');
define('FLD_CID_BNR', '865');
define('FLD_CID_CNR', '866');
define('FLD_CID_DATETIME', '867');
define('FLD_CID_DATEHEADER', '868');
define('FLD_CID_LENGTH', '869');
define('FLD_FLASHSTATE', '870');
define('FLD_STAT_MODE', '900');
define('FLD_CONFIG_REC', '910');
define('FLD_BIN_DATA', '920');
define('FLD_BIN_EXT', '921');
define('FLD_BIN_FILENAME', '922');
define('FLD_BIN_MIME', '923');
define('FLD_DB_HOST', '940');
define('FLD_DB_DATABASE', '941');
define('FLD_DB_LOGIN', '942');
define('FLD_DB_PASSWORD', '943');
define('FLD_PBXINFO', '950');
define('FLD_USERDATA', '990');

define("CONNECTOR_STX", "\x02");
define("CONNECTOR_ETX", "\x03");
define("CONNECTOR_SEP", "\x04");
define("CONNECTOR_SUB", "\x05");
define("CONNECTOR_SSB", "\x06");
define("CONNECTOR_ESB", "\x07");
define("CONNECTOR_ISUB", "\x08");

/**
 *  The Connector class uses IP and ConnectorPacket to provide a simple interface to
 *  the Vision 80/20 connector.
 */
class Connector
{
    private $ip;
    private $authorized = false;

    public $session = "";

    private function assertConnected()
    {
        if (!$this->connected())
            die('Trying to use Connector communication while disconnected. This is not possible.');
    }

    public function __construct()
    {
        $this->ip = new IP();
        $this->ip->timeout = 8;
    }

    public function __destruct()
    {
        $this->ip->disconnect();
    }

    public function connect($host, $port)
    {
        return $this->ip->connect($host, $port);
    }

    public function disconnect()
    {
        $this->ip->disconnect();
    }

    public function send(ConnectorPacket $packet)
    {
        $this->assertConnected();
        $this->ip->send($packet->packet());
    }

    public function read()
    {
        $data = $this->ip->readeol(CONNECTOR_ETX);
        if ($data == "")
            return null;

        return ConnectorPacket::decode($data);
    }

    public function connected()
    {
        return $this->ip->connected();
    }

    public function sessionized()
    {
        return $this->ip->connected() && $this->session != "";
    }

    public function authorized()
    {
        return $this->ip->connected() && $this->sessionized() && $this->authorized;
    }

    public function stat()
    {
        $this->send(new ConnectorPacket('STAT'));

        if (($packet = $this->read()) == null)
            die("Connector: STAT did not receive a reply");

        return $packet;
    }

    public function req_s()
    {
        $this->send(new ConnectorPacket('REQ-S'));

        if (($packet = $this->read()) == null)
            die("Connector: REQ-S did not receive a reply");

        if ($packet->errno == 0)
            $this->session = $packet->get('000');

        return $packet;
    }

    public function end()
    {
        $this->send(new ConnectorPacket('END', array(
            FLD_SESSION => $this->session
        )));

        if (($packet = $this->read()) == null)
            die("Connector: END did not receive a reply");

        $this->session = "";

        return $packet;
    }

    public function auth($anknr, $password)
    {
        $this->send(new ConnectorPacket('AUTH', array(
            FLD_SESSION => $this->session,
            FLD_ANKNR => $anknr,
            FLD_PASSWORD => $password
        )));

        if (($packet = $this->read()) == null)
            die("Connector: AUTH did not receive a reply");

        $this->authorized = $packet->success();

        return $packet;
    }

    public function signon($value)
    {
        $this->send(new ConnectorPacket('AUTH', array(
            FLD_SESSION => $this->session,
            FLD_SIGNON => $value
        )));

        if (($packet = $this->read()) == null)
            die("Connector: AUTH did not receive a reply");

        $this->authorized = $packet->success();

        return $packet;
    }

    public function info($id = "")
    {
        $packet = new ConnectorPacket('INFO', array(
            FLD_SESSION => $this->session
        ));
        if ($id != "")
            $packet->add(FLD_ID, $id);
        $this->send($packet);

        if (($packet = $this->read()) == null)
            die("Connector: INFO did not receive a reply");

        return $packet;
    }

    public function info_data($id = "")
    {
        $packet = new ConnectorPacket('INFO-DATA', array(
            FLD_SESSION => $this->session
        ));
        if ($id != "")
            $packet->add(FLD_ID, $id);
        $this->send($packet);

        if (($packet = $this->read()) == null)
            die("Connector: INFO-DATA did not receive a reply");

        return $packet;
    }

    public function int_call($number)
    {
        $this->send(new ConnectorPacket('INT-CALL', array(
            FLD_SESSION => $this->session,
            FLD_INT_TARGET => $number
        )));

        if (($packet = $this->read()) == null)
            die("Connector: INT-CALL did not receive a reply");

        return $packet;
    }
}
